name: Build and Push to Docker Hub

on:
  push:
    branches: [ "main" ]

jobs:
  # 1. ê¹ƒí—ˆë¸Œ ìŠˆí¼ì»´í“¨í„°ë¡œ ë¹Œë“œí•´ì„œ Docker Hubì— ì˜¬ë¦¬ëŠ” ì‘ì—…
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ë°±ì—”ë“œ ë¹Œë“œ & í‘¸ì‹œ
      - name: Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./strength-log-backend  # ğŸ‘ˆ ë°±ì—”ë“œ í´ë”ëª… í™•ì¸!
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/strength-log-backend:latest

      # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ & í‘¸ì‹œ
      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./strength-log-frontend     # ğŸ‘ˆ í”„ë¡ íŠ¸ì—”ë“œ í´ë”ëª… í™•ì¸!
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/strength-log-frontend:latest
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}

  # 2. ì„œë²„í•œí…Œ "ìƒˆê±° ë‚˜ì™”ìœ¼ë‹ˆ ê°€ì ¸ê°€!" ë¼ê³  ëª…ë ¹í•˜ëŠ” ì‘ì—…
  deploy-to-server:
    needs: build-and-push # ìœ„ ì‘ì—…ì´ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰ë¨
    runs-on: ubuntu-latest
    steps:
      - name: Tell Server to Pull Image
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            cd strength-log
            git pull origin main
            
            # 1. ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (ì„œë²„ëŠ” ë‹¤ìš´ë§Œ ë°›ìŒ!)
            docker compose pull
            
            # 2. ê°ˆì•„ë¼ìš°ê¸° (ìˆœì‹ê°„ì— ëë‚¨)
            docker compose up -d
            
            # 3. ì°Œêº¼ê¸° ì²­ì†Œ
            docker image prune -f