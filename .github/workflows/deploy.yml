name: Deploy to GCP

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH Remote Commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 90m  # <--- 여기 추가! (60분까지 기다려라)
          script: |
            cd strength-log
            git pull origin main
            
            # 1. 기존 컨테이너 내리기 (메모리 확보)
            docker compose down
            
            # 2. 백엔드 먼저 빌드 (가벼움)
            docker compose build backend
            
            # 3. 프론트엔드 나중에 빌드 (무거움) - 이제 혼자 리소스 독점 가능
            docker compose build frontend
            
            # 4. 이미 빌드된 걸로 실행만 함
            docker compose up -d
            
            # 5. 청소
            docker image prune -f